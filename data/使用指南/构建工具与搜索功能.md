# 构建工具与搜索功能

本文档介绍 EasyDocument 系统中的构建工具和搜索功能的使用方法。

## 构建工具 (build.py)

EasyDocument 提供了一个功能强大的 Python 构建工具 `build.py`，用于自动扫描文档目录并生成路径文件和搜索索引。该工具还支持收集Git版本控制信息并与GitHub集成。

> 请注意，这个只是辅助工具，实际上您完全可以不使用这个脚本，也不需要将这个脚本部署到服务器上

### 基本用法

```bash
python build.py [选项]
```

### 可用选项

| 选项 | 说明 |
|------|------|
| `--root DIRECTORY` | 指定文档根目录 (默认: data) |
| `--output FILE` | 指定输出的路径文件名 (默认: path.json) |
| `--merge` | 合并已有的JSON文件，保留顺序和自定义字段 |
| `--config FILE` | 指定配置文件路径 (默认: config.js) |
| `--search-index FILE` | 指定搜索索引输出文件名 (默认: search.json) |
| `--no-git` | 禁用Git相关功能 |
| `--no-search` | 禁用搜索索引生成 |
| `--no-github` | 禁用GitHub API查询 |

### 标准模式

标准模式会重新生成完整的路径文件，不保留任何自定义排序或结构：

```bash
python build.py
```

这将扫描 `data` 目录并生成 `path.json` 文件。

### 合并模式

合并模式(使用`--merge`选项)允许你保留已有的文件结构、排序和自定义字段，这对于维护手动编辑过的 `path.json` 文件非常有用：

```bash
python build.py --merge
```

合并模式的特点：

1. 保留现有文件和目录的排序
2. 保留自定义字段（如 `order`）
3. 更新文档标题（如果有变化）
4. 将新文件添加到相应目录的末尾
5. 自动移除不再存在的文件和目录

这使得你可以手动编辑 `path.json` 文件来创建自定义导航结构，而不必担心下次运行构建工具时会丢失这些更改。

### 搜索索引生成

默认情况下，构建工具会生成搜索索引文件。如果您不需要搜索功能，可以使用 `--no-search` 选项禁用索引生成：

```bash
python build.py --no-search
```

要指定搜索索引文件的输出路径：

```bash
python build.py --search-index custom-search.json
```

搜索索引生成过程包括：

1. 提取每个文档的内容（移除标记、代码块等）
2. 自动分析并提取关键词
3. 生成内容摘要
4. 将所有信息保存到搜索索引文件

### Git与GitHub功能

构建工具可以收集文档的Git版本控制信息，如最后修改时间、贡献者列表等。要使用此功能，您需要安装`gitpython`库：

```bash
pip install gitpython
```

相关选项：

- `--no-git`: 完全禁用Git功能
- `--no-github`: 只禁用GitHub API查询（不获取贡献者头像），但保留基本Git信息

Git功能会自动从仓库中提取：

1. 每个文档的最后修改时间和修改者
2. 每个文档的贡献者列表及其贡献次数
3. 如果启用GitHub功能，会获取贡献者的GitHub用户名和头像

这些信息会被保存在 `path.json` 文件中，然后在前端显示。

### 自定义配置

构建工具会自动从 `config.js` 文件中读取配置，您也可以使用 `--config` 选项指定自定义配置文件：

```bash
python build.py --config my-config.js
```

特别是，构建工具会识别配置中的Git和GitHub设置，以决定是否启用相关功能。

## 搜索功能

EasyDocument 内置了全文搜索功能，允许用户快速查找文档内容。

### 使用搜索

1. 点击顶栏右侧的搜索图标 <i class="fas fa-search"></i>
2. 在弹出的搜索模态窗口中输入关键词（至少2个字符）
3. 按下回车键或点击搜索按钮执行搜索
4. 查看搜索结果列表，点击感兴趣的条目跳转到相应文档

### 搜索结果展示

搜索结果包含以下信息：

- 文档标题（匹配部分高亮显示）
- 内容预览（匹配部分高亮显示，并显示上下文）
- 文档路径

### 搜索功能特点

- **实时搜索**：完全在前端执行，无需等待服务器响应
- **全文检索**：搜索文档标题、内容和关键词
- **智能匹配**：突出显示匹配的关键词并显示上下文
- **适配主题**：支持明暗两种主题模式

### 搜索索引更新

每次添加、修改或删除文档后，应该重新生成搜索索引，以确保搜索结果的准确性：

```bash
python build.py --merge
```

### 自定义搜索索引

在某些情况下，你可能需要自定义搜索索引生成过程。你可以修改 `build.py` 中的相关函数：

1. `extract_keywords` 函数：控制关键词提取算法和最大关键词数量
2. `extract_content` 函数：处理文档内容提取及最大提取字符数
3. `build_search_tree` 函数：构建搜索索引数据结构

## 性能注意事项

- 对于大型文档库，搜索索引文件可能会变得很大，影响加载速度
- GitHub API查询会减慢构建过程，可以使用 `--no-github` 选项加快构建速度
- 考虑优化文档内容，移除不必要的内容以减小索引大小
- 对于非常大的文档库，可能不适合使用本项目的搜索功能，建议自行实现或考虑其它专业搜索解决方案

## GitHub Actions自动构建

为了方便文档的自动更新，EasyDocument已集成GitHub Actions工作流，可以在文档内容更新时自动运行构建工具，更新路径和搜索索引。

### 自动构建触发条件

工作流配置文件位于 `.github/workflows/build-document.yml`，包含以下触发条件：

1. 当 `data/` 目录下的文件有变更并推送到 `main` 分支时自动触发
2. 支持从GitHub Actions页面手动触发执行

### 工作流程功能

自动构建工作流会执行以下操作：

1. 检出完整的代码仓库历史（保证Git相关功能可用）
2. 设置Python环境并安装必要依赖
3. 执行 `build.py --merge` 命令更新文档索引
4. 如果生成的文件有变化，自动提交并推送更改

### 使用自动构建

要利用此功能，您只需：

1. 修改 `data/` 目录中的文档内容
2. 将修改推送到GitHub仓库
3. GitHub Actions会自动执行构建过程并更新索引文件

如需手动触发构建，可以在GitHub仓库页面的"Actions"标签页中选择"Build Document"工作流，然后点击"Run workflow"按钮。

### 自定义自动构建

如果需要自定义自动构建过程，可以编辑 `.github/workflows/build-document.yml` 文件：

- 修改触发条件（如监控不同的文件路径）
- 更改构建命令参数（如禁用特定功能）
- 添加其他依赖或处理步骤