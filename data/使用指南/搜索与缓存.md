# 搜索与缓存功能

本文档介绍 EasyDocument 系统中的搜索和缓存功能。

## 搜索功能

EasyDocument 内置了全文搜索功能，允许用户快速查找文档内容。
详细配置请参考[搜索功能配置](配置详解/搜索功能.md)

### 使用搜索

1. 点击顶栏右侧的搜索图标 <i class="fas fa-search"></i>
2. 在弹出的搜索模态窗口中输入关键词（至少2个字符）
3. 按下回车键或点击搜索按钮执行搜索
4. 查看搜索结果列表，点击感兴趣的条目跳转到相应文档

### 多匹配项显示与跳转

EasyDocument 的搜索功能支持在搜索结果中显示同一文档内的多个匹配位置，并可以直接跳转到特定的匹配项：

1. **多匹配项显示**：当一个关键词在文档中多次出现时，搜索结果会显示多个匹配位置的预览（默认相距至少50个字符，可在配置中通过`match_distance`调整）。
2. **匹配位置编号**：每个匹配项都标有"第x个"的编号，表示这是文档中的第几个匹配项。
3. **精确跳转**：点击特定的匹配项预览，系统会直接跳转到文档中对应的位置并高亮显示。
4. **高亮消失**：为不影响阅读体验，匹配项的高亮会在5秒后自动淡出。
5. **URL清理**：跳转后15秒，系统会自动从URL中移除搜索参数，保持URL的整洁。

此功能特别适合在长文档中精确定位所需内容，用户可以通过点击不同的匹配预览快速比较文档中的多个相关段落。

### 搜索结果展示

搜索结果包含以下信息：

- 文档标题（匹配部分高亮显示）
- 内容预览（多个匹配位置的内容片段，匹配部分高亮显示）
- 文档路径

### 搜索功能特点

- **实时搜索**：完全在前端执行，无需等待服务器响应
- **自动搜索**：支持边输入边搜索的实时搜索模式（需在配置中启用）
- **全文检索**：搜索文档标题、内容和关键词
- **智能匹配**：突出显示匹配的关键词并显示上下文
- **多位置跳转**：支持跳转到文档中特定的匹配位置
- **适配主题**：支持明暗两种主题模式

### 实时搜索

EasyDocument 支持两种搜索模式：

1. **按需搜索**（默认）：输入关键词后按回车键或点击搜索按钮执行搜索。
2. **实时搜索**：输入关键词时自动执行搜索，结果随输入内容即时更新。

要启用实时搜索，请在 `config.js` 中设置：

```javascript
search: {
  search_on_type: true // 启用实时搜索
}
```

实时搜索使用了防抖技术，在用户停止输入300毫秒后才会执行搜索，这样可以避免在快速输入时过度消耗系统资源。

对于文档量较大的系统，实时搜索可能会影响性能。

### 搜索索引更新

每次添加、修改或删除文档后，应该通过运行构建工具 (`build.py`) 重新生成搜索索引，以确保搜索结果的准确性：

```bash
python build.py --merge
```

### 缓存搜索

EasyDocument 的搜索功能现在支持搜索 **缓存** 和 **预加载** 的文档内容。这意味着：

- 您可以搜索最近访问过的文档（持久缓存）和系统自动预加载的文档（内存缓存）。
- 即使在离线状态下，只要文档在缓存中，也可以被搜索到。
- 搜索结果会明确标记哪些结果来自缓存或预加载。
  - <i class="fas fa-database text-blue-500"></i> 图标表示来自持久缓存（保留10分钟）。
  - <i class="fas fa-bolt text-purple-500"></i> 图标表示来自预加载缓存（刷新页面后丢失）。

此功能默认启用。您可以在 `config.js` 中通过 `search.search_cached` 选项控制是否搜索缓存内容。

### 自定义搜索索引

在某些情况下，你可能需要自定义搜索索引生成过程。你可以修改 `build.py` 中的相关函数：

1. `extract_keywords` 函数：控制关键词提取算法和最大关键词数量
2. `extract_content` 函数：处理文档内容提取及最大提取字符数
3. `build_search_tree` 函数：构建搜索索引数据结构

## 缓存管理器

EasyDocument 引入了缓存管理器，让您可以更直观地了解和控制文档的缓存状态。

### 缓存状态指示器

当您加载一个文档后，页面右下角会出现一个状态指示器，显示当前文档的缓存状态：

- <i class="fas fa-database text-blue-500"></i> **已缓存**: 表示文档来自持久缓存（10分钟内有效）
- <i class="fas fa-bolt text-purple-500"></i> **预加载**: 表示文档来自内存预加载缓存（刷新后失效）
- <i class="fas fa-ban text-gray-500"></i> **未启用**: 表示缓存和预加载功能都已被禁用

点击这个状态指示器，即可打开缓存管理面板。

### 缓存管理面板功能

缓存管理面板提供以下功能：

#### 缓存统计
- 显示当前预加载文档和持久缓存文档的数量
- 显示缓存功能的启用/禁用状态

#### 预加载文档管理
- **文档列表**: 列出所有已预加载的文档路径
- **手动预加载**: 点击"开始预加载"按钮，系统会自动加载 `path.json` 中定义的所有文档（优先加载未缓存的）
- **清除缓存**: 可以清除所有预加载缓存或单个移除特定文档

#### 持久缓存管理
- **文档列表**: 列出所有在持久缓存中的文档路径及缓存时间（如"5分钟前"）
- **清除缓存**: 可以清除所有持久缓存或单个移除特定文档

#### 缓存控制开关
- **禁用文档缓存**: 勾选后将不再缓存新访问的文档，也不会使用已有的持久缓存
- **禁用预加载**: 勾选后将停止自动预加载功能，也不会使用已有的预加载缓存

缓存控制开关于 v1.2.4 起添加，当两个开关都启用时，右下角的状态指示器会显示为"未启用"状态。

> [TIP] 禁用预加载
>
> 即使您禁用了预加载功能，在打开一个文档时依然会先请求文档再加载，只是不会缓存到内存中。
> 这是为了用户体验

### 缓存机制说明

#### 预加载缓存
- 系统会在后台自动加载一些您可能接下来会访问的文档（基于当前文档的同级和子级文档）
- 这些文档存储在内存中，访问速度极快
- 刷新页面后会丢失，需要重新预加载
- 可以通过"禁用预加载"开关控制

#### 持久缓存
- 您访问过的文档会自动存储在浏览器的本地存储中
- 有效期为10分钟，即使刷新页面或关闭浏览器后重新打开（在10分钟内），这些文档也能快速加载
- 超过10分钟的缓存会自动清理
- 可以通过"禁用文档缓存"开关控制

#### 缓存优先级
当同一文档既在预加载缓存又在持久缓存中时，系统会优先使用预加载缓存，因为它的访问速度更快。

缓存管理器为您提供了对这两种缓存的完全透明度和控制权，让您可以根据需要灵活管理文档缓存。 